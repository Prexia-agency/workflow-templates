name: üõ°Ô∏è Security Base Scan

on:
  workflow_call:
    inputs:
      node-version:
        description: 'Node.js version to use'
        required: false
        type: string
        default: '20'
      severity-threshold:
        description: 'Snyk severity threshold (low|medium|high|critical)'
        required: false
        type: string
        default: 'high'
    secrets:
      GITGUARDIAN_API_KEY:
        required: true
      SNYK_TOKEN:
        required: true
    outputs:
      vulnerabilities-found:
        description: 'Number of vulnerabilities found'
        value: ${{ jobs.dependency-scan.outputs.vuln-count }}

jobs:
  secret-scan:
    name: Scan for Leaked Secrets
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better detection

      - name: GitGuardian Security Scan
        uses: GitGuardian/ggshield-action@v1
        env:
          GITGUARDIAN_API_KEY: ${{ secrets.GITGUARDIAN_API_KEY }}
          GITHUB_PUSH_BEFORE_SHA: ${{ github.event.before }}
          GITHUB_PUSH_BASE_SHA: ${{ github.event.base }}
          GITHUB_PULL_BASE_SHA: ${{ github.event.pull_request.base.sha }}
          GITHUB_DEFAULT_BRANCH: ${{ github.event.repository.default_branch }}

  dependency-scan:
    name: Scan Dependencies for Vulnerabilities
    runs-on: ubuntu-latest
    needs: secret-scan  # Only run if no secrets found
    outputs:
      vuln-count: ${{ steps.snyk.outputs.vulnerabilities }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run Snyk Security Scan
        id: snyk
        uses: snyk/actions/node@master
        continue-on-error: true  # Don't block on low-severity