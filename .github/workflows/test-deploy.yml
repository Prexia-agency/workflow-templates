name: Test Deploy
on:
  workflow_call:
    inputs:
      deployment-url:
        required: true
        type: string
      environment:
        required: true
        type: string
      enforce-performance:
        type: boolean
        default: false

permissions:
  contents: read

jobs:
  # ===== JOB 1: E2E + ACCESSIBILITY (GATES DEPLOYMENT) =====
  e2e-accessibility:
    name: E2E & Accessibility Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout
        uses: actions/checkout@v4.2.2
      
      - name: Setup Node.js
        uses: actions/setup-node@v4.0.4
        with:
          node-version: "20"
          cache: npm
      
      - name: Install dependencies
        run: npm ci
      
      - name: Cache Playwright
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ hashFiles('package-lock.json') }}
      
      - name: Install Playwright
        run: npx playwright install --with-deps chromium
      
      # ===== WAIT FOR DEPLOYMENT =====
      - name: Wait for deployment
        timeout-minutes: 8
        run: |
          URL="${{ inputs.deployment-url }}"
          echo "Waiting for ${URL}..."
          
          for i in {1..48}; do
            CODE=$(curl -s -o /dev/null -w "%{http_code}" "${URL}" 2>/dev/null || echo "000")
            if [[ "${CODE}" =~ ^(200|301|302|304)$ ]]; then
              echo "âœ… Ready (HTTP ${CODE})"
              sleep 10
              exit 0
            fi
            echo "â³ ${i}/48 - HTTP ${CODE}"
            sleep 10
          done
          exit 1
      
      # ===== E2E + ACCESSIBILITY =====
      - name: Playwright E2E + WCAG tests
        run: npx playwright test
        env:
          BASE_URL: ${{ inputs.deployment-url }}
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4.4.3
        with:
          name: e2e-results-${{ inputs.environment }}-${{ github.run_id }}
          path: |
            playwright-report/
            test-results/
          retention-days: 30

  # ===== JOB 2: LIGHTHOUSE (PARALLEL, INFORMATIONAL) =====
  lighthouse:
    name: Lighthouse Performance
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: []
    steps:
      - name: Checkout
        uses: actions/checkout@v4.2.2
      
      # ===== WAIT FOR DEPLOYMENT + WARMUP =====
      - name: Wait for deployment and warm up
        timeout-minutes: 10
        run: |
          URL="${{ inputs.deployment-url }}"
          echo "Waiting for ${URL} and warming up..."
          
          # Wait for HTTP ready
          for i in {1..48}; do
            CODE=$(curl -s -o /dev/null -w "%{http_code}" "${URL}" 2>/dev/null || echo "000")
            if [[ "${CODE}" =~ ^(200|301|302|304)$ ]]; then
              echo "âœ… HTTP Ready (${CODE})"
              break
            fi
            echo "â³ ${i}/48 - HTTP ${CODE}"
            sleep 10
          done
          
          # Warm up: Make 3 requests to prime cache, lambdas, CDN
          echo "ðŸ”¥ Warming up site..."
          for i in {1..3}; do
            curl -s "${URL}" > /dev/null
            sleep 5
          done
          
          # Final stabilization wait
          echo "â¸ï¸  Stabilization period..."
          sleep 30
          
          echo "âœ… Site is Lighthouse-ready"
      
      - name: Install Chromium, Xvfb and Lighthouse
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            xvfb \
            chromium-browser \
            chromium-chromedriver \
            fonts-liberation \
            libnss3 \
            libatk-bridge2.0-0 \
            libgtk-3-0 \
            libgbm1
          npm install -g lighthouse@12.1.0

      
      # ===== RUN LIGHTHOUSE WITH HEADED CHROME =====
      - name: Run Lighthouse (headed Chrome with virtual display)
        id: lighthouse
        run: |
          # Start virtual display
          export DISPLAY=:99
          Xvfb :99 -screen 0 1920x1080x24 > /dev/null 2>&1 &
          
          # Wait for display to be ready
          sleep 3
          
          # Run Lighthouse
          lighthouse "${{ inputs.deployment-url }}" \
          --output=json \
          --output=html \
          --output-path=./lighthouse-report.report \
          --preset=desktop \
          --chrome-path=/usr/bin/chromium-browser \
          --chrome-flags="--no-sandbox --disable-dev-shm-usage" \
          --quiet

          
          echo "âœ… Lighthouse completed successfully"
        continue-on-error: ${{ !inputs.enforce-performance }}
      
      # ===== CHECK LIGHTHOUSE SCORES =====
      - name: Check Lighthouse scores
        if: always() && steps.lighthouse.outcome == 'success'
        run: |
          # Extract scores from JSON report
          ACCESSIBILITY=$(jq '.categories.accessibility.score * 100' lighthouse-report.report.json)
          BEST_PRACTICES=$(jq '."best-practices".score * 100' lighthouse-report.report.json 2>/dev/null || echo "0")
          SEO=$(jq '.categories.seo.score * 100' lighthouse-report.report.json)
          
          echo "ðŸ“Š Lighthouse Scores:"
          echo "  Accessibility: ${ACCESSIBILITY}%"
          echo "  Best Practices: ${BEST_PRACTICES}%"
          echo "  SEO: ${SEO}%"
          
          # Fail if scores are below thresholds (only if enforcement enabled)
          if [ "${{ inputs.enforce-performance }}" = "true" ]; then
            if (( $(echo "$ACCESSIBILITY < 90" | bc -l) )); then
              echo "âŒ Accessibility score too low: ${ACCESSIBILITY}%"
              exit 1
            fi
            if (( $(echo "$SEO < 90" | bc -l) )); then
              echo "âŒ SEO score too low: ${SEO}%"
              exit 1
            fi
          fi
      
      # ===== UPLOAD RESULTS =====
      - name: Upload Lighthouse results
        if: always()
        uses: actions/upload-artifact@v4.4.3
        with:
          name: lighthouse-results-${{ inputs.environment }}-${{ github.run_id }}
          path: |
            lighthouse-report.*
          retention-days: 30
      
      - name: Fail if performance enforcement enabled
        if: ${{ inputs.enforce-performance && steps.lighthouse.outcome == 'failure' }}
        run: |
          echo "âŒ Lighthouse failed and enforce-performance is enabled"
          exit 1

  # ===== JOB 3: SECURITY SCAN (PARALLEL, INFORMATIONAL) =====
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: []
    steps:
      - name: Checkout
        uses: actions/checkout@v4.2.2
      
      - name: Wait for deployment
        timeout-minutes: 8
        run: |
          URL="${{ inputs.deployment-url }}"
          for i in {1..48}; do
            CODE=$(curl -s -o /dev/null -w "%{http_code}" "${URL}" 2>/dev/null || echo "000")
            if [[ "${CODE}" =~ ^(200|301|302|304)$ ]]; then
              echo "âœ… Ready"
              sleep 10
              exit 0
            fi
            sleep 10
          done
          exit 1
      
      - name: OWASP ZAP Scan
        uses: zaproxy/action-full-scan@v0.10.0
        with:
          target: ${{ inputs.deployment-url }}
          cmd_options: "-a"
        continue-on-error: true

  # ===== JOB 4: SUMMARY (AFTER ALL) =====
  summary:
    name: Test Summary
    runs-on: ubuntu-latest
    if: always()
    needs: [e2e-accessibility, lighthouse, security]
    steps:
      - name: Generate Summary
        run: |
          echo "# ðŸ“Š Test Results: ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** ${{ inputs.deployment-url }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Test Suite | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| E2E + Accessibility | ${{ needs.e2e-accessibility.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Lighthouse | ${{ needs.lighthouse.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Scan | ${{ needs.security.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ inputs.enforce-performance }}" = "true" ]; then
            echo "âš ï¸ **Performance enforcement:** ENABLED" >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸ **Performance enforcement:** Informational only" >> $GITHUB_STEP_SUMMARY
          fi
